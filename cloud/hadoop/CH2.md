# CHAPTER 2

# Ch2

## Ch2.1

- 전세계 20세기의 기상 정보를 분석해보자
    - 수많은 기상 관측소가 존재하므로 작은 파일이 매우 많이 존재한다.
    - 다만 하둡은 적은 수의 큰 파일들을 처리하는데 효율적이기 떄문에 전처리를 좀 해보자

## Ch2.2

- 연도별 최고 온도를 찾아보자!
    - 그냥 쭉 iteration 돌면서 최댓값 찾는 방법
        - 42분 걸림! → 결과적으로 MR 사용하면 6분 걸림;
    - 그럼 병렬로 쪼개서 처리해보자! 다만 문제가 세가지 있는데..
        - 일을 동일한 크기로 쪼갤 수 없다.
            - 결국 전체 수행 시간은 가장 큰 파일을 처리하는 시간에 따라 결정
        - 병렬로 쪼갠 데이터들을 합치는게 오히려 처리가 어려울 수 있다.
        - 단일 머신은 여전히 한계가 존재한다. 쪼개봤자 담당하는 개별 머신의 성능이 별로면 전체 성능은 제한될 것
    - 이렇듯 병렬 처리는 매우 까다롭고 힘들다. 하둡은 이걸 편하게 해준다!

## Ch2.3

- 맵 리듀스 잡의 형태로 다시 만들어보자구

### Ch2.3.1

- 맵
    - 입력: 원본 데이터
    - key: 행의 오프셋, value: 데이터
    - 각 행에서 연도와 기온을 추출해서 데이터를 제공한다.
    - 출력: (연도, 온도) key-value 쌍
- 리듀스로 넘어갈때 키-값 쌍은 키를 기준으로 정렬된 다음 그룹화 된다.
- 리듀스
    - 입력: (연도, [온도들])
    - 출력: (연도, 최대 온도)

### Ch2.3.2 자바 맵리듀스

- 맵: Mapper를 상속해서 만든다.
- 리듀스: Reducer 상속
- 하둡의 타입 클래스
    - LongWritable: Long
    - Text: String
    - IntWritable: Integer
- 잡 명세서 작성
    - 입출력 경로 지정
        - 출력 경로에서 지정한 디렉터리가 잡 수행 시점에 존재하면 절대 안된다 (덮어쓰기 방지)
    - 일반적으로 맵 합수의 출력 타입 == 리듀스 함수의 출력 타입
        - 다르다면 setMapOutputKeyClass() 이런걸로 지정해줘야한다.

## 2.4 분산형으로 확장하기

- 앞의 예제에서는 출력을 로컬의 파일시스템에 했다.
- 다만 하둡은 확장을 위해
    - HDFS에 데이터 저장
    - 클러스터의 각 머신에서 MR을 실행
    - 이를 위해 YARN이라는 하둡 자원 관리 시스템 이용

### 2.4.1 데이터 흐름

- MR 잡: 수행되는 작업의 기본 단위
    - 입력 데이터
    - MR 프로그램
    - 설정 정보
- 하둡은 이 잡을 맵 태스크, 리듀스 태스크로 나우어 진행 → YARN으로 스케쥴링
- 이때, 잡에 들어오는 입력을 스플릿 - 쪼개서 각 스플릿마다 맵 태스크를 생성.
    - 로드밸런싱에 좋다
    - 다만, 스플릿 크기가 너무 작으면 오버헤드가 너무 커져서 잡 실행시간이 오히려 증가한다.
    - 128MB가 적절하다.
- 하둡은 데이터가 있는 노드에서 맵 태스크를 실행할 때 가장 빠르다 (data locality)
    - 네트워크를 사용하지 않기 떄문에
    - 다음과 같은 순서로 속도가 느려진다
        - 같은 노드에 태스크, HDFS 블록 존재
        - 같은 랙이지만 다른 노드에 존재
        - 다른 랙에 존재 (네트워크 필요)
    - 따라서 스플릿의 크기는 HDFS의 한 블럭의 크기와 같아야한다.
        - 하나의 스플릿이 두 블럭에 걸쳐 있으면 구 블럭이 같은 노드에 존재할 가능성이 낮기 떄문
- 리듀스는 딱히 locality가 없다.
    - 모든 맵퍼에서 결과를 받기 떄문에
    - 모든 맵퍼의 결과는 하나의 리듀서로 간다
    - 다만 리듀스도 여러개일 수도 있고 아예 없을수도 있다.

### 2.4.2 컴바이너 함수

- 맵 → 리듀스로 가는 네트워크 대역폭은 한계가 있으므로 맵의 결과를 처리하는 컴바이너 함수가 필요하다.
- 각 맵에서 리듀스를 한번 미리 적용하고 넘기는 느낌이지
- 맵: 데이터 → 리듀스: 최댓값 이거를 맵:데이터 → 컴바이너: 최댓값 (리듀스) → 리듀스: 최댓값 이런식으로!

## 2.5 하둡 스트리밍

- 자바 말고도 다른 언어로 MR을 작성하는데, 이때 스트리밍 즉 입출력을 받는 식으로 구현할 수 있다.
    - 자바 API
        - 한번에 하나의 레코드만 처리
    - 스트리밍
        - 한번에 여러행을 읽어서 처리할 수 있다.
